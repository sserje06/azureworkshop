trigger: none
name: $(date:yyyyMMdd)$(rev:.r)

jobs:
- job: createEnvironments
  steps:
  - task: PowerShell@2
    displayName: Generate Environments
    inputs:
      targetType: 'inline'
      script: |
        $newArray=[ordered] @{}
        $environments = "${env:VAR_ENVIRONMENTS}"
        $getArray = $environments.split(",")

        foreach ($i in $getArray){
            $newArray += @{
                $i = @{"env"=$i}
            }
        }
        $convertArrayToJson = $newArray | convertTo-json -Compress
        echo "##vso[task.setVariable variable=environments;isOutput=true]$convertArrayToJson"
    name: matrix_deployment 
- job: Build
  dependsOn: createEnvironments
  displayName: Creating Environments
  strategy:
    matrix: $[dependencies.createEnvironments.outputs['matrix_deployment.environments']]
    maxParallel: 1
  pool:
   vmImage: ubuntu-18.04
  steps:
  - checkout: self
  - task: PowerShell@2
    displayName: Runing Taks 01
    inputs:
      targetType: 'inline'
      script: |
        # Write your PowerShell commands here.
        
        Write-Host "Hello World"
  - task: PowerShell@2
    displayName: Runing Taks 02
    inputs:
      targetType: 'inline'
      script: |
        # Write your PowerShell commands here.
        
        Write-Host "Hello World"
